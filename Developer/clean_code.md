# Принципы чистого кода

## Введение

Чистый код — это код, который легко читать, понимать и поддерживать. Он написан так, будто это проза, предназначенная для людей, а не только для машин. Цель этого документа — предоставить практические советы, которые помогут сделать ваш код более качественным.

## Последовательность и форматирование

Единообразие стиля — ключ к читаемости. Когда весь код в проекте выглядит так, будто его написал один человек, новым разработчикам гораздо проще в нём ориентироваться.

*   **Следуйте стандарту [PER](https://www.php-fig.org/per/coding-style/)**. Он объединяет лучшие практики из PSR-1, PSR-2 и PSR-12.
*   **Используйте автоматические инструменты** для форматирования, такие как **Laravel Pint** или **PHP-CS-Fixer**. Это избавит от споров о стиле и обеспечит его соблюдение.

### Пример

```php
// ❌ Плохо: отсутствует единый стиль
class ChirpController extends Controller {
  public  function index (){
        $chirps = Chirp::with('user')->latest()->get();
        return view('chirps.index',[
'chirps' => $chirps]);
    }
}

// ✅ Хорошо: последовательное форматирование
class ChirpController extends Controller
{
    public function index()
    {
        $chirps = Chirp::with('user')->latest()->get();

        return view('chirps.index', [
            'chirps' => $chirps,
        ]);
    }
}
```

## Избегайте "магических чисел"

"Магические числа" — это числовые литералы, используемые в коде без объяснения их смысла. Они усложняют понимание и поддержку.

Вместо них используйте **именованные константы** или **перечисления (Enums)**.

### Пример

```php
// ❌ Плохо: что означает `1`?
if ($status == 1) {
    // ...
}

// ✅ Хорошо: использование константы
const STATUS_ACTIVE = 1;

if ($status === STATUS_ACTIVE) {
    // ...
}

// ✅ Отлично: использование перечисления (Enum)
enum Status: int
{
    case ACTIVE = 1;
    case INACTIVE = 2;
    case ARCHIVED = 3;
}

if ($status === Status::ACTIVE) {
    // ...
}
```

## Избегайте использования `else`

Глубокая вложенность условий делает код трудным для восприятия. Старайтесь минимизировать использование `else`, применяя **ранние возвраты (early returns)**.

### Пример

```php
// ❌ Плохо: глубокая вложенность
public function isUserAllowedToAccess(User $user): bool {
    if (!$user->isBanned()) {
        if ($user->isAdmin() || $user->isGranted(GRANT::EDIT)) {
            return true;
        } else {
            return false;
        }
    } else {
        return false;
    }
}

// ✅ Хорошо: ранние возвраты
public function isUserAllowedToAccess(User $user): bool
{
    if ($user->isBanned()) {
        return false;
    }

    if ($user->isAdmin() || $user->isGranted(GRANT::EDIT)) {
        return true;
    }

    return false;
}
```

## "Счастливый путь" (Happy Path)

Этот принцип гласит, что основной, позитивный сценарий выполнения функции должен быть на верхнем уровне вложенности. Все проверки, исключения и пограничные случаи должны обрабатываться в самом начале.

Это делает код более читаемым, так как основная логика не "тонет" внутри условных блоков.

### Пример

```php
// ❌ Плохо: основная логика внутри условия
public function processFile(string $path): void
{
    if (file_exists($path)) {
        // ...
        // Много строк основной логики
        // ...
    } else {
        throw new FileNotFoundException();
    }
}

// ✅ Хорошо: сначала обработка ошибки
public function processFile(string $path): void
{
    if (!file_exists($path)) {
        throw new FileNotFoundException();
    }

    // ...
    // Основная логика здесь, без лишней вложенности
    // ...
}
```

## Ключевые принципы чистого кода в Laravel

### 1. Тонкие контроллеры, "толстые" модели/сервисы

Контроллер должен отвечать только за приём HTTP-запроса и возврат ответа. Вся бизнес-логика должна быть вынесена в другие слои.

*   **Плохо:** вся логика валидации, создания пользователя и отправки email находится в контроллере.
*   **Хорошо:**
    *   **Валидация:** вынесена в `Form Request` (`StoreUserRequest`).
    *   **Бизнес-логика:** вынесена в **Сервис** (`UserService`) или **Действие** (`CreateUserAction`).
    *   **Отправка email:** выполняется через **события и слушатели** (`UserRegistered` -> `SendWelcomeEmailListener`) или **задания в очереди** (`SendWelcomeEmailJob`).

### 2. Принцип единственной ответственности (Single Responsibility Principle)

Каждый класс или метод должен иметь только одну причину для изменения.

*   **Класс `User` (модель):** отвечает только за представление данных таблицы `users` и её отношения. Он не должен отправлять email или обрабатывать платежи.
*   **Класс `InvoiceController`:** метод `store` отвечает только за создание счёта. Метод `show` — только за его отображение. Для сложных операций используйте **контроллеры одиночного действия** (с методом `__invoke`).

### 3. Не повторяйтесь (Don't Repeat Yourself - DRY)

Laravel предоставляет множество инструментов для избежания дублирования кода:

*   **Повторяющийся UI:** используйте **компоненты Blade**.
*   **Повторяющиеся запросы Eloquent:** используйте **Query Scopes** в моделях.
*   **Повторяющаяся логика валидации:** используйте **Form Requests**.
*   **Повторяющаяся логика в разных контроллерах:** выносите её в **сервисы** или **трейты**.

### 4. Предпочитайте полиморфизм условным операторам

Вместо громоздких `if/else` или `switch` для реализации разной логики (например, разные платёжные системы) используйте паттерн "Стратегия".

*   **Создайте интерфейс** (например, `PaymentGatewayInterface`).
*   **Создайте реализации** для каждого шлюза (`StripeGateway`, `PayPalGateway`).
*   **Используйте сервис-контейнер Laravel**, чтобы привязать интерфейс к нужной реализации в зависимости от конфигурации.

### 5. Конфигурация превыше всего

Никогда не храните константы, ключи API или настройки в коде.

*   **Всегда используйте `config/` файлы** для настроек приложения.
*   **Для чувствительных данных используйте `.env` файл** и обращайтесь к ним через `config()`.

## Резюме

*   **Пишите код для людей.** Он должен быть понятен без дополнительных объяснений.
*   **Соблюдайте единый стиль.** Автоматизируйте этот процесс.
*   **Избавляйтесь от "магических" значений.** Используйте константы и перечисления.
*   **Уменьшайте вложенность.** Применяйте ранние возвраты.
*   **Следуйте принципу "счастливого пути"**.
*   **Используйте всю мощь фреймворка,** чтобы писать более чистый и поддерживаемый код.
