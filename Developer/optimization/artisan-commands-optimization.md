# Оптимизация Artisan-команд Laravel.

Предотвращение нагрузки на сервер из-за некорректного использования конструкторов команд.

--------------------------------------------
ПРОБЛЕМА
--------------------------------------------
Laravel при каждом запуске своих консольных инструментов (php artisan, schedule:run, horizon, queue workers) создаёт экземпляры ВСЕХ зарегистрированных Artisan-команд.

Это означает:
- вызываются конструкторы всех команд сразу,
- даже если запускается только одна команда,
- и даже если команда не будет выполнена.

Если в конструкторе содержатся тяжёлые зависимости (API-клиенты, SDK, файловые сервисы и т.п.), они будут создаваться постоянно. Это вызывает:

- лишнюю нагрузку на CPU и память
- увеличение времени выполнения cron (schedule:run)
- лишнее создание HTTP-клиентов, файловых сервисов, API-объектов
- замедление работы приложения

--------------------------------------------
ПРИЧИНЫ
--------------------------------------------

1. Laravel инициализирует все классы Artisan-команд при каждом вызове консоли.
2. Конструктор команды отрабатывает ВСЕГДА, даже если команда не выполняется.
3. Тяжёлые зависимости в конструкторе создают скрытую нагрузку, особенно если любая команда выполняется часто (вручную или по расписанию)

--------------------------------------------
ПРИМЕР ПРОБЛЕМЫ
--------------------------------------------

Если команда содержит:

```php
public function __construct(NovaPoshtaApi2 $api)
{
    parent::__construct();
    $this->api = $api;
}
```

То NovaPoshtaApi2 будет создаваться каждый раз, когда выполнится:

```bash
php artisan schedule:run
```
или по расписанию и даже если сама команда не нужна.

--------------------------------------------
РЕШЕНИЕ
--------------------------------------------

1. Оставлять в конструкторе только лёгкие зависимости:
   - репозитории
   - простые сервисы
   - конфиги
   - строки, параметры, флаги

2. Тяжёлые зависимости переносить в метод handle():

```php
public function handle()
{
    $api = app(NovaPoshtaApi2::class);
}
```

3. Тяжёлыми считаются:
   - API/HTTP клиенты
   - SDK (PromAPI, Nova Poshta, Telegram, CRM)
   - Blade Compiler
   - FilesystemManager
   - Redis, Elasticsearch клиенты
   - сервисы изображений (GD, Imagick, свои обёртки)
   - любые сервисы, создающие соединения, читающие файлы или имеющие тяжёлый DI-граф

4. Можно использовать ленивую загрузку:

```php
protected ?NovaPoshtaApi2 $api = null;

protected function api()
{
    return $this->api ??= app(NovaPoshtaApi2::class);
}
```

--------------------------------------------
РЕЗУЛЬТАТ
--------------------------------------------

- schedule:run станет быстрее
- нагрузка на сервер уменьшится
- API-клиенты будут создаваться только когда команда реально работает
- исчезнут лишние задержки и всплески потребления памяти
- команда с heavy зависимостями перестанет тормозить весь cron

--------------------------------------------
ОБЯЗАТЕЛЬНО
--------------------------------------------

Данное правило распространяется на ВСЕ artisan-команды проекта.
Все новые команды должны создаваться с пустым конструктором.
